<!DOCTYPE html>
<html>
  <head>
    <title>thingy.rs</title>
    <script>
      window.exports = window;
      window["tiny-warning"] = function () {
        console.log(arguments);
      };
      window.require = function (name) {
        return window[name];
      };
      window.warning = function () {
        console.log(arguments);
      };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/history@4.10.1/cjs/history.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/preact/10.5.12/preact.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/htm/3.0.4/htm.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/preact-router/3.2.1/preact-router.js"></script>
    <script>
      html = htm.bind(preact.h);
    </script>
    <style>
      html {
        width: 100vw;
        margin: 0;
        padding: 0;
      }
      body {
        width: 100vw;
        margin: 0;
        padding: 0;
        overflow-x: hidden;
        overflow-y: auto;
      }
      * {
        padding: unset;
        margin: unset;
      }
      h1,
      h2,
      h3,
      h4,
      h5 {
        display: unset;
      }
      table {
        width: 100%;
        text-align: justify;
      }
      tr:nth-child(odd) {
        background-color: antiquewhite;
      }
      tr:hover {
        background-color: azure;
      }
      .root {
        max-width: 1500px;
        margin-left: 15%;
        margin-right: 15%;
      }
      .nav {
        margin-bottom: 2em;
      }
      .title {
        padding-top: 1em;
        padding-bottom: 1em;
        margin-bottom: 1em;
        display: flex;
        justify-content: space-between;
        background-color: aliceblue;
      }
      .logs {
        height: calc(100vh - 150px);
        overflow: auto;
      }
    </style>
    <base href="/index.html" />
  </head>
  <body>
    <script type="module">
      const { Component, render, createRef } = preact;
      const { Router, route, Link } = preactRouter;
      const { createHashHistory, createBrowserHistory } = window;

      class App extends Component {
        constructor(props) {
          super(props);
          this.setState({});
        }

        render(_props, {}) {
          return html`
    <div class="root">
      <nav class="nav">
        <h3>Thingy build server and thing-doer</h3>
      </nav>
      <${Router} history=${createHashHistory()}>
        <${Jobs} path="/" />
        <${Job} path="/jobs/:id" />
        <${Branch} path="/jobs/:job/branches/:branch" />
        <${Log} path="/jobs/:job/branches/:branch/builds/:build_num/log" />
        <${Error} type="404" default />
      </${Router}>
    </div>`;
        }
      }

      class Jobs extends Component {
        constructor(props) {
          super(props);
          this.setState({ jobs: [], loading: true });
        }
        componentDidMount() {
          this.loadData();
        }
        loadData = () => {
          this.setState({ loading: true, jobs: [] }, () => {
            fetch("/jobs")
              .then((res) => {
                res.json().then((jobs) => {
                  this.setState({ jobs });
                });
              })
              .finally(() => {
                this.setState({ loading: false });
              });
          });
        };
        poll = (id) => {
          fetch(`/jobs/${id}/poll`, { method: "POST" }).then((res) => {
            res.json().then((data) => console.log(data));
          });
        };
        render() {
          const { loading, jobs } = this.state;
          if (loading) return "Loading...";
          return html`
            <div class="title">
              <div><h4>Home</h4></div>
              <div>
                <a href="javascript:void(0);" onClick=${this.loadData}
                  >Reload</a
                >
              </div>
            </div>
            <table>
              <thead>
                <tr>
                  <th>Job</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                ${jobs.map(
                  (job) => html`
                  <tr>
                    <td><${Link} href=${`/jobs/${job.name}`}>${job.name}</Link></td>
                    <t><a href="javascript:void(0);" onClick=${() =>
                      this.poll(job.name)}>Poll now</a></td>
                  </tr>
                `
                )}
              </tbody>
            </table>
          `;
        }
      }

      class Job extends Component {
        constructor(props) {
          super(props);
          this.setState({ job: undefined, loading: true });
        }
        componentDidMount() {
          this.loadData();
        }
        loadData = () => {
          const { id } = this.props;
          this.setState({ loading: true }, () => {
            fetch(`/jobs/${id}`).then((res) => {
              res.json().then((job) => {
                this.setState({ job: job || {}, loading: false });
              });
            });
          });
        };
        poll = () => {
          const { id } = this.props;
          fetch(`/jobs/${id}/poll`, { method: "POST" }).then((res) => {
            this.loadData();
          });
        };
        render() {
          const { loading, job } = this.state;
          return html`<div class="job">
            ${loading
              ? "Loading..."
              : html`
                  <div class="title">
                    <div><h4><${Link} href=${`/`}>Home</${Link}></h4> / <h4>${
                  job.name
                }</h4></div>
                    <div>
                      <a href="javascript:void(0);" onClick=${this.poll}
                        >Poll Now</a
                      >
                    </div>
                    <div>
                      <a href="javascript:void(0);" onClick=${this.loadData}
                        >Reload</a
                      >
                    </div>
                  </div>
                  <table>
                    <thead>
                      <tr><th>Branch</th></tr>
                    </thead>
                    <tbody>
                      ${(job.branches || []).map(
                      (b) => html`
                      <tr class="item">
                        <td><${Link} href=${`/jobs/${job.name}/branches/${b}`}>${b}</${Link}></td>
                      </tr>
                      `
                    )}
                    </tbody>
                  </table>
                `}
          </div>`;
        }
      }

      class Branch extends Component {
        constructor(props) {
          super(props);
          this.state = { loading: true, branchDetails: undefined };
        }
        componentDidMount() {
          this.loadData();
        }
        loadData = () => {
          const { job, branch } = this.props;
          this.setState({ loading: true }, () => {
            fetch(`/jobs/${job}/branches/${branch}`).then((res) => {
              res.json().then((branchDetails) => {
                this.setState({ branchDetails, loading: false }, () => {
                  // keep reloading if any build is running
                  if (
                    (branchDetails.builds || []).filter(
                      (b) => b.status === "building"
                    )?.length
                  ) {
                    setTimeout(this.loadData, 2000);
                  }
                });
              });
            });
          });
        };
        buildNow = () => {
          const { job, branch } = this.props;
          fetch(`/jobs/${job}/branches/${branch}/builds`, {
            method: "POST",
          }).then((res) => {
            this.loadData();
          });
        };
        abort = (build_num) => {
          const { job, branch } = this.props;
          fetch(`/jobs/${job}/branches/${branch}/builds/${build_num}`, {
            method: "DELETE",
          }).then((res) => {
            this.loadData();
          });
        };
        render({ job, branch }, { loading, branchDetails }) {
          if (loading) return "Loading...";
          return html`<div class="branch">
      <div class="title">
        <div><h4><${Link} href=${`/`}>Home</${Link}></h4> / <${Link} href=${`/jobs/${job}`}><h4>${job}</h4></${Link}> / <h4>${branch}</h4></div>
        <div><a href="javascript:void(0);" onClick=${
          this.buildNow
        }>Build Now</a></div>
        <div><a href="javascript:void(0);" onClick=${
          this.loadData
        }>Reload</a></div>
      </div>
      <div>
        <table>
          <thead>
            <tr><th>Build #</th><th>Commit</th><th>Status</th><th></th></tr>
          </thead>  
          <tbody>
            ${(branchDetails.builds || []).reverse().map(
              (b) => html`
                <tr>
                  <td>${b.build_num}</td>
                  <td>${b.commit_hash}</td>
                  <td>${b.status}</td>
                  <td>
                    ${
                      b.status === "building"
                        ? html`<a
                            href="javascript:void(0);"
                            onClick=${() => this.abort(b.build_num)}
                            >Abort</a
                          >`
                        : ""
                    }
                    <${Link} href=${`/jobs/${job}/branches/${branch}/builds/${b.build_num}/log`}>Logs</${Link}>
                  </td>
                </tr>
              `
            )}
          </tbody>
        </table>
      </div>
    </div>`;
        }
      }

      class Log extends Component {
        constructor(props) {
          super(props);
          this.state = {
            line_idx: 0,
            page_size: 10,
            loading: false,
            lines: [],
            status: undefined,
          };
        }
        componentDidMount() {
          this.loadData();
        }
        reload = () => {
          this.setState(
            { line_idx: 0, page_size: 10, loading: false, lines: [] },
            () => {
              this.loadData();
            }
          );
        };
        loadData = () => {
          const { job, branch, build_num } = this.props;
          const { line_idx, page_size, lines: existingLines } = this.state;
          this.setState({ loading: true }, () => {
            fetch(
              `/jobs/${job}/branches/${branch}/builds/${build_num}/log?start=${line_idx}&num_lines=${page_size}`
            ).then((res) => {
              res.json().then(({ has_more, lines, status }) => {
                existingLines.push(...lines);
                this.setState({
                  line_idx: existingLines.length,
                  lines: [...existingLines],
                  status,
                });
                if (has_more || status == "building") {
                  setTimeout(() => {
                    this.loadData();
                  }, 500);
                }
              });
            });
          });
        };
        abort = () => {
          const { job, branch, build_num } = this.props;
          fetch(`/jobs/${job}/branches/${branch}/builds/${build_num}`, {
            method: "DELETE",
          }).then((res) => {
            this.loadData();
          });
        };
        render({ job, branch, build_num }, { lines, status }) {
          return html`<div class="title">
          <div>
            <h4><${Link} href=${`/`}>Home</${Link}></h4> / <h4><${Link} href=${`/jobs/${job}`}><h4>${job}</h4></${Link}></h4> / <h4><${Link} href=${`/jobs/${job}/branches/${branch}`}><h4>${branch}</h4></${Link}></h4> / <h4>${build_num}</h4> / logs
          </div>
          ${
            status === "building"
              ? html`<div>
                  <a href="javascript:void(0);" onClick=${this.abort}
                    >Abort Build</a
                  >
                </div>`
              : ""
          }
          <div><a href="javascript:void(0);" onClick=${
            this.loadData
          }>Reload</a></div>
        </div>
        <div class="logs">${lines.map((l) => html`<pre>${l}</pre>`)}</div>`;
        }
        componentDidUpdate() {
          try {
            const div = document.querySelector(".logs");
            div.scrollTop = div.scrollHeight - div.clientHeight;
          } catch (e) {}
        }
      }

      class Error extends Component {
        render() {
          const { type, url } = this.props;
          return html`<section class="error">
            <h2>Error ${type}</h2>
            <p>It looks like we hit a snag.</p>
            <pre>${url}</pre>

            <div>Go to <a href="/">home</a></div>
          </section>`;
        }
      }

      render(html`<${App} />`, document.body);
    </script>
  </body>
</html>
